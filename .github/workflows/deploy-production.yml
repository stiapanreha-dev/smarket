name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_approval:
        description: 'Skip manual approval'
        required: false
        default: 'false'

env:
  NODE_VERSION: '18'
  DOCKER_REGISTRY: docker.io
  DOCKER_IMAGE_NAME: ${{ secrets.DOCKER_USERNAME }}/snailmarketplace
  ENVIRONMENT: production

jobs:
  # Job 1: Build and Push Docker Image
  build:
    name: Build & Push Production Image
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate version
        id: version
        run: |
          VERSION=$(git describe --tags --always --dirty)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE_NAME }}
          tags: |
            type=raw,value=production-latest
            type=raw,value=production-${{ steps.version.outputs.version }}
            type=raw,value=production-{{date 'YYYYMMDD-HHmmss'}}
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production
            VERSION=${{ steps.version.outputs.version }}

      - name: Create release artifact
        run: |
          echo "Version: ${{ steps.version.outputs.version }}" > release-info.txt
          echo "Image: ${{ env.DOCKER_IMAGE_NAME }}:production-${{ steps.version.outputs.version }}" >> release-info.txt
          echo "Built at: $(date)" >> release-info.txt

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-info
          path: release-info.txt

  # Job 2: Manual Approval Gate
  approval:
    name: Manual Approval Required
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: production-approval

    steps:
      - name: Request approval
        run: |
          echo "üîí Manual approval required for production deployment"
          echo "Version: ${{ needs.build.outputs.version }}"
          echo "Waiting for approval..."

  # Job 3: Blue-Green Deployment
  deploy-blue-green:
    name: Blue-Green Deployment
    runs-on: ubuntu-latest
    needs: [build, approval]
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
    outputs:
      deployment-id: ${{ steps.deploy.outputs.deployment-id }}
      previous-version: ${{ steps.backup.outputs.previous-version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Backup current deployment
        id: backup
        run: |
          echo "üíæ Backing up current deployment..."

          # Get current production version
          # CURRENT_VERSION=$(kubectl get deployment snailmarketplace -n production \
          #   -o jsonpath='{.spec.template.spec.containers[0].image}')

          CURRENT_VERSION="production-backup-$(date +%s)"
          echo "previous-version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "Backed up version: $CURRENT_VERSION"

      - name: Deploy to Green environment
        id: deploy
        run: |
          echo "üü¢ Deploying to Green environment..."

          # Example: Deploy new version to green environment
          # kubectl set image deployment/snailmarketplace-green \
          #   app=${{ env.DOCKER_IMAGE_NAME }}:production-${{ needs.build.outputs.version }} \
          #   --namespace=production

          # Wait for rollout
          # kubectl rollout status deployment/snailmarketplace-green -n production

          # Example deployment script
          DEPLOYMENT_ID="deploy-$(date +%s)"
          echo "deployment-id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT
          echo "url=https://snailmarketplace.com" >> $GITHUB_OUTPUT

          echo "‚úÖ Green deployment completed"

      - name: Run smoke tests on Green
        run: |
          echo "üß™ Running smoke tests on Green environment..."

          # Health check
          # HEALTH_STATUS=$(curl -s -o /dev/null -w '%{http_code}' \
          #   ${{ secrets.PRODUCTION_GREEN_URL }}/health)

          # if [ "$HEALTH_STATUS" != "200" ]; then
          #   echo "‚ùå Smoke tests failed"
          #   exit 1
          # fi

          echo "‚úÖ Smoke tests passed"

      - name: Run database migrations
        run: |
          echo "üîÑ Running database migrations..."
          # Run migrations on production database
          # kubectl exec -it deployment/snailmarketplace-green -n production -- \
          #   npm run migration:run
          echo "‚úÖ Migrations completed"

      - name: Warm up Green environment
        run: |
          echo "üî• Warming up Green environment..."
          sleep 30
          echo "‚úÖ Green environment ready"

  # Job 4: Traffic Switch
  switch-traffic:
    name: Switch Traffic to Green
    runs-on: ubuntu-latest
    needs: deploy-blue-green
    outputs:
      switched: ${{ steps.switch.outputs.switched }}

    steps:
      - name: Switch traffic to Green
        id: switch
        run: |
          echo "üîÑ Switching traffic from Blue to Green..."

          # Example: Update load balancer or service to point to green
          # kubectl patch service snailmarketplace -n production \
          #   -p '{"spec":{"selector":{"version":"green"}}}'

          # Or update ingress
          # kubectl patch ingress snailmarketplace -n production \
          #   --type=json -p='[{"op": "replace", "path": "/spec/rules/0/http/paths/0/backend/service/name", "value":"snailmarketplace-green"}]'

          echo "switched=true" >> $GITHUB_OUTPUT
          echo "‚úÖ Traffic switched to Green environment"

      - name: Monitor metrics
        run: |
          echo "üìä Monitoring production metrics..."
          sleep 60
          echo "‚úÖ Metrics look good"

  # Job 5: Health Validation
  validate-production:
    name: Validate Production Health
    runs-on: ubuntu-latest
    needs: switch-traffic

    steps:
      - name: Run production health checks
        id: health
        run: |
          echo "üè• Running production health checks..."

          MAX_ATTEMPTS=10
          ATTEMPT=1
          FAILED=0

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Health check attempt $ATTEMPT of $MAX_ATTEMPTS"

            # HEALTH_STATUS=$(curl -s -o /dev/null -w '%{http_code}' \
            #   ${{ secrets.PRODUCTION_URL }}/health || echo "000")

            HEALTH_STATUS="200"  # Simulated

            if [ "$HEALTH_STATUS" = "200" ]; then
              echo "‚úÖ Health check passed"
            else
              echo "‚ö†Ô∏è Health check failed with status: $HEALTH_STATUS"
              FAILED=$((FAILED + 1))
            fi

            ATTEMPT=$((ATTEMPT + 1))
            sleep 10
          done

          if [ $FAILED -gt 3 ]; then
            echo "‚ùå Too many health check failures"
            exit 1
          fi

          echo "‚úÖ Production health validated"

      - name: Check error rates
        run: |
          echo "üìà Checking error rates..."

          # Check error rates from monitoring system
          # ERROR_RATE=$(curl -s "${{ secrets.MONITORING_URL }}/api/error-rate")

          # if (( $(echo "$ERROR_RATE > 5.0" | bc -l) )); then
          #   echo "‚ùå Error rate too high: $ERROR_RATE%"
          #   exit 1
          # fi

          echo "‚úÖ Error rates within acceptable range"

      - name: Check response times
        run: |
          echo "‚è±Ô∏è Checking response times..."

          # AVG_RESPONSE_TIME=$(curl -s "${{ secrets.MONITORING_URL }}/api/response-time")

          # if (( $(echo "$AVG_RESPONSE_TIME > 1000" | bc -l) )); then
          #   echo "‚ùå Response time too high: ${AVG_RESPONSE_TIME}ms"
          #   exit 1
          # fi

          echo "‚úÖ Response times within acceptable range"

  # Job 6: Automatic Rollback (on failure)
  rollback:
    name: Automatic Rollback
    runs-on: ubuntu-latest
    needs: [deploy-blue-green, switch-traffic, validate-production]
    if: failure()

    steps:
      - name: Trigger rollback
        run: |
          echo "üîô Triggering automatic rollback..."

          # Switch traffic back to Blue environment
          # kubectl patch service snailmarketplace -n production \
          #   -p '{"spec":{"selector":{"version":"blue"}}}'

          echo "‚úÖ Rolled back to previous version"

      - name: Verify rollback
        run: |
          echo "üîç Verifying rollback..."

          # HEALTH_STATUS=$(curl -s -o /dev/null -w '%{http_code}' \
          #   ${{ secrets.PRODUCTION_URL }}/health)

          # if [ "$HEALTH_STATUS" != "200" ]; then
          #   echo "‚ùå Rollback verification failed"
          #   exit 1
          # fi

          echo "‚úÖ Rollback verified"

      - name: Notify rollback
        run: |
          echo "üì¢ Notifying team about rollback..."
          # Send alert to team
          # curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
          #   -H 'Content-Type: application/json' \
          #   -d '{"text":"‚ö†Ô∏è Production deployment rolled back automatically!"}'

  # Job 7: Cleanup Blue Environment
  cleanup:
    name: Cleanup Blue Environment
    runs-on: ubuntu-latest
    needs: [validate-production]
    if: success()

    steps:
      - name: Scale down Blue environment
        run: |
          echo "üßπ Scaling down Blue environment..."

          # Keep Blue running for quick rollback if needed
          # kubectl scale deployment snailmarketplace-blue --replicas=1 -n production

          echo "‚úÖ Blue environment scaled down"

      - name: Mark deployment complete
        run: |
          echo "‚úÖ Deployment completed successfully"
          echo "Version: ${{ needs.build.outputs.version }}"

  # Job 8: Post-deployment Monitoring
  post-deployment:
    name: Post-deployment Monitoring
    runs-on: ubuntu-latest
    needs: [validate-production]
    if: success()

    steps:
      - name: Monitor for 5 minutes
        run: |
          echo "üëÄ Monitoring production for 5 minutes..."

          for i in {1..5}; do
            echo "Monitoring... ($i/5 minutes)"
            # Check metrics, logs, alerts
            sleep 60
          done

          echo "‚úÖ Post-deployment monitoring complete"

      - name: Create deployment record
        run: |
          echo "üìù Creating deployment record..."
          echo "Deployment completed at $(date)"
          echo "Version: ${{ needs.build.outputs.version }}"

  # Job 9: Notifications
  notify:
    name: Send Deployment Notifications
    runs-on: ubuntu-latest
    needs: [post-deployment]
    if: always()

    steps:
      - name: Notify on success
        if: needs.post-deployment.result == 'success'
        run: |
          echo "‚úÖ Production deployment successful!"
          # curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
          #   -H 'Content-Type: application/json' \
          #   -d '{"text":"‚úÖ Production deployment successful!\nVersion: ${{ needs.build.outputs.version }}"}'

      - name: Notify on failure
        if: needs.post-deployment.result == 'failure' || needs.validate-production.result == 'failure'
        run: |
          echo "‚ùå Production deployment failed and rolled back!"
          # curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
          #   -H 'Content-Type: application/json' \
          #   -d '{"text":"‚ùå Production deployment failed and rolled back!"}'
