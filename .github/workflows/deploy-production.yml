name: Deploy to Production

on:
  push:
    branches:
      - master
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy:
    name: Deploy to Pi4-2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Clone/Update repository on server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            set -e

            APP_DIR="$HOME/apps/smarket/backend"

            # Check if repository exists
            if [ -d "$APP_DIR/.git" ]; then
              echo "Repository exists, pulling latest changes..."
              cd "$APP_DIR"
              git fetch origin
              git reset --hard origin/master
            else
              echo "Cloning repository for the first time..."
              mkdir -p "$APP_DIR"
              cd "$HOME/apps/smarket"
              git clone git@github.com:${{ github.repository }}.git backend
              cd backend
            fi

            echo "Current commit: $(git rev-parse HEAD)"
            echo "Current branch: $(git branch --show-current)"
          ENDSSH

      - name: Create .env file
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            APP_DIR="$HOME/apps/smarket/backend"
            cd "$APP_DIR"

            # Create .env.production if it doesn't exist
            if [ ! -f .env.production ]; then
              echo "Creating .env.production file..."
              cat > .env.production << 'ENVEOF'
          NODE_ENV=production
          PORT=3000

          # Database
          DB_HOST=postgres
          DB_PORT=5432
          DB_USERNAME=snailmarket
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_DATABASE=snailmarket

          # Redis
          REDIS_HOST=redis
          REDIS_PORT=6379

          # JWT
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
          JWT_EXPIRATION=15m
          JWT_REFRESH_EXPIRATION=7d
          ENVEOF
            fi
          ENDSSH

      - name: Run deployment script
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
            set -e
            cd "$HOME/apps/smarket"
            ./scripts/deploy.sh
          ENDSSH

      - name: Verify deployment
        run: |
          echo "Waiting for service to be ready..."
          sleep 15

          # Check if API is responding
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://smarket.sh3.su/health || echo "000")

          if [ "$RESPONSE" = "200" ]; then
            echo "âœ… Deployment successful! API is healthy."
          else
            echo "âŒ Deployment may have issues. HTTP status: $RESPONSE"
            exit 1
          fi

      - name: Notify on success
        if: success()
        run: |
          echo "ðŸš€ Deployment to production completed successfully!"
          echo "ðŸ”— API: https://smarket.sh3.su/api/v1"

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ Deployment failed! Check the logs above."
